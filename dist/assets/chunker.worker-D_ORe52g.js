function a(s,c){const{wpm:i,minDuration:o,maxDuration:r}=c,t=i/60;let e=s.trim().split(/\s+/).length/t*1e3,n=1;return s.includes("...")||s.includes("â€¦")?n+=.3:s.includes(".")||s.includes("!")||s.includes("?")?n+=.2:(s.includes(",")||s.includes(";")||s.includes(":"))&&(n+=.1),(s.includes("â€”")||s.includes("â€“"))&&(n+=.15),(s.includes('"')||s.includes('"')||s.includes('"'))&&(n+=.1),e*=n,Math.max(o,Math.min(r,e))}function h(s,c=120){const i=s.split(new RegExp("(?<=[.!?])\\s+")),o=[];let r="";for(const l of i)r&&(r+" "+l).length>c?(r.trim()&&o.push(r.trim()),r=l):r=r?r+" "+l:l;if(r.trim()&&o.push(r.trim()),o.length===0){const l=s.split(/[,;:]\s+/);let e="";for(const n of l)e&&(e+", "+n).length>c?(e.trim()&&o.push(e.trim()),e=n):e=e?e+", "+n:n;e.trim()&&o.push(e.trim())}const t=[];for(const l of o)if(l.length<=c)t.push(l);else{const e=l.split(" ");let n="";for(const u of e)n&&(n+" "+u).length>c?(n.trim()&&t.push(n.trim()),n=u):n=n?n+" "+u:u;n.trim()&&t.push(n.trim())}return t.filter(l=>l.trim().length>0)}function f(s,c){console.log("ðŸ”§ Processing chapters:",s.length);const i=[];let o=0;return s.forEach((r,t)=>{console.log(`ðŸ”§ Chapter ${t}: ${r.title}, content length: ${r.content.length}`);const l=h(r.content);console.log(`ðŸ”§ Generated ${l.length} chunks for chapter ${t}`),l.forEach((e,n)=>{const u=a(e,c);console.log(`ðŸ”§ Chunk ${o}: "${e.substring(0,50)}..." (${e.length} chars, ${u}ms)`),i.push({id:`${t}-${n}`,text:e,chapterIndex:t,chunkIndex:n,duration:u}),o++})}),console.log("ðŸ”§ Total chunks created:",i.length),i}self.addEventListener("message",s=>{console.log("ðŸ”§ Worker received message:",s.data);const{type:c,payload:i}=s.data;if(c==="PROCESS_CHAPTERS")try{console.log("ðŸ”§ Processing",i.chapters.length,"chapters...");const o=f(i.chapters,i.timingConfig);console.log("ðŸ”§ Generated",o.length,"chunks");const r={type:"CHUNKS_PROCESSED",payload:{chunks:o}};console.log("ðŸ”§ Sending response to main thread"),self.postMessage(r)}catch(o){console.error("ðŸ”§ Worker error:",o),self.postMessage({type:"ERROR",payload:{error:o instanceof Error?o.message:"Unknown error"}})}});
